<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Da Li·ªÖu Demo</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 40px auto; }
    textarea, input, button { width: 100%; margin: 8px 0; padding: 8px; }
    #result { border: 1px solid #ccc; padding: 10px; margin-top: 15px; background: #fafafa; }
  </style>
</head>
<body>
  <h2>üß† Ph√¢n t√≠ch da b·∫±ng AI</h2>

  <form id="skin-form">
    <label>M√¥ t·∫£ tri·ªáu ch·ª©ng:</label>
    <textarea id="desc" rows="4" placeholder="V√≠ d·ª•: xu·∫•t hi·ªán m·ª•n ƒë·ªè, ng·ª©a quanh m≈©i..."></textarea>

    <label>Ch·ªçn ·∫£nh v√πng da:</label>
    <input type="file" id="image" accept="image/*">

    <button type="submit">Ph√¢n t√≠ch</button>
  </form>

  <div id="result">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>

  <script>
  const API_BASE = "http://127.0.0.1:5001";  // üîß s·ª≠a port 5000 ‚Üí 5001

  // H√†m n√©n ·∫£nh nhanh
  async function compressImage(file, maxW = 1024, quality = 0.82) {
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();
    const scale = Math.min(1, maxW / img.naturalWidth);
    const canvas = document.createElement('canvas');
    canvas.width = Math.round(img.naturalWidth * scale);
    canvas.height = Math.round(img.naturalHeight * scale);
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    return new Promise((resolve) => {
      canvas.toBlob((blob) => {
        resolve(new File([blob], file.name.replace(/\.\w+$/, '') + ".jpg", { type: "image/jpeg" }));
      }, "image/jpeg", quality);
    });
  }

  document.getElementById("skin-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = e.submitter;
    const desc = document.getElementById("desc").value.trim();
    const file = document.getElementById("image").files[0];
    const result = document.getElementById("result");

    result.textContent = "";
    if (!desc || !file) {
      result.textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√¥ t·∫£ v√† ch·ªçn ·∫£nh.";
      return;
    }

    btn.disabled = true; btn.textContent = "‚è≥ ƒêang ph√¢n t√≠ch‚Ä¶";

    try {
      const small = await compressImage(file);
      const fd = new FormData();
      fd.append("description", desc);
      fd.append("image", small, small.name);

      const res = await fetch(`${API_BASE}/analyze`, { method: "POST", body: fd });
      const data = await res.json();

      if (!res.ok) {
        result.textContent = data.error || `L·ªói ${res.status}`;
        return;
      }

      result.innerHTML = `
        <h3>üìä K·∫øt qu·∫£ s∆° b·ªô</h3>
        <p><b>Ch·∫©n ƒëo√°n kh·∫£ dƒ©:</b> ${data.diagnosis ?? "‚Äî"}</p>
        <p><b>ƒê·ªô tin c·∫≠y:</b> ${data.confidence ? (Math.round(data.confidence*100) + "%") : "‚Äî"}</p>
        <p><b>ƒêi·ªÅu ki·ªán c√≥ th·ªÉ li√™n quan:</b> ${(data.likely_conditions || []).join(", ") || "‚Äî"}</p>
        <p><b>G·ª£i √Ω b∆∞·ªõc ti·∫øp theo:</b></p>
        <ul>${(data.next_steps || []).map(s => `<li>${s}</li>`).join("") || "<li>‚Äî</li>"}</ul>
        <small>${data.disclaimer || "‚öïÔ∏è K·∫øt qu·∫£ ch·ªâ mang t√≠nh tham kh·∫£o, kh√¥ng thay th·∫ø t∆∞ v·∫•n y khoa."}</small>
      `;
    } catch (err) {
      result.textContent = "‚ùå L·ªói m·∫°ng ho·∫∑c m√°y ch·ªß. Th·ª≠ l·∫°i sau.";
      console.error(err);
    } finally {
      btn.disabled = false; btn.textContent = "Ph√¢n t√≠ch";
    }
  });
  </script>
</body>
</html>
